name: Vangers Linux Build

on: [push, pull_request]

env: 
  VANGE_RS_REF: 5dae095d4d5bf13ba293b9e772657a004d808fc2

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: vange-rs -- cache build
      uses: actions/cache@v2
      id: vange-rs-cache-build
      with:
        path: vange-rs/target/release/librusty_vangers.a
        key: ${{ env.VANGE_RS_REF }}

    - name: install rustup toolchain
      if: steps.vange-rs-cache-build.outputs.cache-hit != 'true'
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable

    - name: vange-rs -- download
      if: steps.vange-rs-cache-build.outputs.cache-hit != 'true'
      uses: actions/checkout@v2
      with:
        repository: lpenguin/vange-rs
        ref: ${{ env.VANGE_RS_REF }}
        path: vange-rs

    - name: vange-rs -- build
      if: steps.vange-rs-cache-build.outputs.cache-hit != 'true'
      run: cargo build --release --features env_logger
      working-directory: vange-rs/lib/ffi
      
    - name: vange-rs -- copy artifacts to prefix
      run: sudo cp target/release/librusty_vangers.a /usr/lib/
      working-directory: vange-rs/
      
    - name: update repos
      run: sudo apt-get update
    - name: install libs
      run: sudo apt-get install -yq cmake libsdl2-dev libsdl2-net-dev libogg-dev libvorbis-dev libavcodec-dev libavformat-dev libavutil-dev

    - name: clunk download lib
      run: git clone --depth 1 https://github.com/stalkerg/clunk.git clunk
      working-directory: /tmp

    - name: clunk build and install
      run: cmake -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_C_COMPILER=/usr/bin/gcc-9 -DCMAKE_CXX_COMPILER=/usr/bin/g++-9 . && make && sudo make install
      working-directory: /tmp/clunk

    - name: configure
      run: mkdir build && cd build && cmake -DCMAKE_C_COMPILER=/usr/bin/gcc-9 -DCMAKE_CXX_COMPILER=/usr/bin/g++-9 ..
    - name: make
      run: make
      working-directory: build
